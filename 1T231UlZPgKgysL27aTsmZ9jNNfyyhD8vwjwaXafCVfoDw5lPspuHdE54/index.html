<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>GAS Deployment Manager UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .loader {
      border-top-color: #3b82f6; /* Tailwind blue-500 */
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }
    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 p-4">

  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
      ğŸš€ Apps Script ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ ãƒãƒãƒ¼ã‚¸ãƒ£
    </h1>
    
    <div class="flex items-center space-x-4 mb-6">
        <button id="load-data" onclick="loadData(true)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-md transition duration-150">
            ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        </button>
        <button id="clear-cache" onclick="clearCache()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded shadow-md transition duration-150">
            ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ & å†å–å¾—
        </button>
    </div>

    <div id="status-message" class="py-3 px-4 rounded-lg text-sm text-gray-700 bg-white shadow mb-6">
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æº–å‚™å®Œäº†
    </div>

    <div id="loading-container" class="text-center py-10 hidden">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
        <p class="text-gray-600">ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ä¸­ã§ã™... (å¤§é‡ã®APIã‚³ãƒ¼ãƒ«ãŒç™ºç”Ÿã—ã¾ã™)</p>
    </div>

    <div id="error-alert" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 hidden mb-6" role="alert">
        <p class="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
        <p id="error-detail"></p>
    </div>

    <div id="deployment-list-container" class="bg-white shadow-xl rounded-lg overflow-hidden">
      <!-- ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>
  </div>

<script>
  const statusElement = document.getElementById('status-message');
  const listContainer = document.getElementById('deployment-list-container');
  const loadingContainer = document.getElementById('loading-container');
  const errorAlert = document.getElementById('error-alert');
  const errorDetail = document.getElementById('error-detail');

  const DATE_OPTIONS = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
  
  /**
   * ISO 8601å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’æ•´å½¢ã™ã‚‹
   * @param {string} isoString - ISO 8601å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—
   * @returns {string} æ•´å½¢ã•ã‚ŒãŸæ—¥ä»˜æ–‡å­—åˆ—
   */
  function formatDate(isoString) {
      if (!isoString) return 'ä¸æ˜';
      try {
          // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ­ã‚±ãƒ¼ãƒ«ã‚’æ­£ã—ãæ‰±ãˆã‚‹ã‚ˆã†ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨
          return new Date(isoString).toLocaleDateString(undefined, DATE_OPTIONS);
      } catch (e) {
          return isoString; // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’è¿”ã™
      }
  }


  /**
   * ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰æœ€åˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
   */
  document.addEventListener('DOMContentLoaded', () => {
    loadData(false);
  });

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹
   */
  function clearCache() {
    statusElement.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...';
    listContainer.innerHTML = '';
    loadingContainer.classList.remove('hidden');
    errorAlert.classList.add('hidden');

    google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleFailure)
        .clearCacheAndReload();
  }

  /**
   * ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
   * @param {boolean} forceReload - å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã‹ã©ã†ã‹
   */
  function loadData(forceReload) {
    statusElement.textContent = forceReload 
        ? 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶çš„ã«æ›´æ–°ã—ã¦ã„ã¾ã™...' 
        : 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...';
    listContainer.innerHTML = '';
    loadingContainer.classList.remove('hidden');
    errorAlert.classList.add('hidden');
    
    google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleFailure)
        .loadDeploymentData();
  }

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‘¼ã³å‡ºã—ãŒæˆåŠŸã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ©
   * @param {string} responseJson - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸJSONæ–‡å­—åˆ—
   */
  function handleSuccess(responseJson) {
    loadingContainer.classList.add('hidden');
    
    let data;
    try {
        data = JSON.parse(responseJson);
    } catch (e) {
        handleFailure('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä¸æ­£ãªå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚');
        return;
    }

    if (data.error) {
        handleFailure(data.message);
        return;
    }

    const totalScripts = data.length;
    const errorCount = data.filter(item => item.status === 'ERROR').length;
    const successCount = totalScripts - errorCount;
    statusElement.innerHTML = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚ç·ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ•°: <b>${totalScripts}</b> (æˆåŠŸ: ${successCount}, ã‚¨ãƒ©ãƒ¼: ${errorCount})`;
    
    renderList(data);
  }

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ©
   * @param {string} error - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   */
  function handleFailure(error) {
    loadingContainer.classList.add('hidden');
    statusElement.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ­ãƒ¼ãƒ‰å¤±æ•—';
    errorAlert.classList.remove('hidden');
    errorDetail.textContent = error.toString();
    listContainer.innerHTML = '<p class="text-center text-gray-500 py-10">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
    console.error('GAS Server Error:', error);
  }

  /**
   * å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
   * @param {Array<Object>} data - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
   */
  function renderList(data) {
    let html = '';
    
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å…ˆé ­ã«ç§»å‹•
    data.sort((a, b) => (a.status === 'ERROR' ? -1 : 1));

    data.forEach(item => {
      const isError = item.status === 'ERROR';
      const bgColor = isError ? 'bg-red-50' : 'bg-white';
      const titleColor = isError ? 'text-red-800' : 'text-gray-900';
      const statusIcon = isError ? 'âŒ' : 'âœ…';
      const deploymentsHtml = renderDeployments(item.webApps);

      html += `
        <div class="border-b last:border-b-0 p-4 ${bgColor}">
          <div class="flex items-start justify-between">
            <h2 class="text-lg font-semibold ${titleColor} mb-1 flex items-center space-x-2">
              <span>${statusIcon}</span>
              <span title="${item.title}">${item.title}</span>
            </h2>
            <p class="text-sm font-medium ${isError ? 'text-red-500' : 'text-green-500'}">
              ${item.message}
            </p>
          </div>
          
          <div class="text-xs text-gray-500 mb-2 space-y-1">
              <p>Script ID: <code>${item.id}</code></p>
              <p>ä½œæˆæ—¥æ™‚: ${formatDate(item.createdDate)}</p>
              <p>æœ€çµ‚æ›´æ–°æ—¥æ™‚: ${formatDate(item.modifiedDate)}</p>
          </div>

          ${deploymentsHtml}
        </div>
      `;
    });

    listContainer.innerHTML = html;
  }

  /**
   * å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’HTMLã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
   * @param {Array<Object>} webApps - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
   * @returns {string} ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã®HTML
   */
  function renderDeployments(webApps) {
    if (webApps.length === 0) {
      return '';
    }

    let deploymentsHtml = '<ul class="mt-3 space-y-1 text-sm">';
    webApps.forEach(app => {
      const accessColor = app.access.includes('ANYONE') ? 'text-orange-600' : 'text-blue-600';
      
      deploymentsHtml += `
        <li class="pl-3 border-l-2 border-gray-200">
          <span class="font-medium">Version: ${app.version}</span>
          <span class="text-gray-400">|</span>
          <span class="${accessColor} font-medium">${app.access.replace('_ANONYMOUS', ' (åŒ¿å)')}</span>
          <span class="text-gray-400">|</span>
          <a href="${app.url}" target="_blank" class="text-blue-500 hover:underline">URLã‚’é–‹ã</a>
        </li>
      `;
    });
    deploymentsHtml += '</ul>';
    return deploymentsHtml;
  }
</script>
</body>
</html>