<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>GAS Deployment Manager UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* èª­ã¿è¾¼ã¿ä¸­ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .loader {
      border-top-color: #3b82f6; /* Tailwind blue-500 */
      -webkit-animation: spinner 1.5s linear infinite;
      animation: spinner 1.5s linear infinite;
    }
    @-webkit-keyframes spinner {
      0% { -webkit-transform: rotate(0deg); }
      100% { -webkit-transform: rotate(360deg); }
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-50 p-4 font-sans">

  <div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
      ğŸš€ Apps Script ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ ãƒãƒãƒ¼ã‚¸ãƒ£
    </h1>
    
    <!-- åˆ¶å¾¡ãƒ‘ãƒãƒ« -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between space-y-4 sm:space-y-0 sm:space-x-4 mb-6 p-4 bg-white rounded-lg shadow">
        <div class="flex items-center space-x-4">
            <button id="load-data" onclick="loadData(true)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 text-sm">
                ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            </button>
            <button id="clear-cache" onclick="clearCache()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 text-sm">
                ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ & å†å–å¾—
            </button>
        </div>
        
        <!-- ã‚½ãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="flex items-center space-x-2 text-sm">
            <label for="sort-by" class="text-gray-700 font-medium whitespace-nowrap">ã‚½ãƒ¼ãƒˆ:</label>
            <select id="sort-by" onchange="applySort()" class="border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="status_desc">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (ã‚¨ãƒ©ãƒ¼å„ªå…ˆ)</option>
                <option value="title_asc">ã‚¹ã‚¯ãƒªãƒ—ãƒˆå (æ˜‡é †)</option>
                <option value="title_desc">ã‚¹ã‚¯ãƒªãƒ—ãƒˆå (é™é †)</option>
                <option value="createdDate_asc">ä½œæˆæ—¥æ™‚ (æ˜‡é †)</option>
                <option value="createdDate_desc">ä½œæˆæ—¥æ™‚ (é™é †)</option>
                <option value="modifiedDate_asc">æœ€çµ‚æ›´æ–°æ—¥æ™‚ (æ˜‡é †)</option>
                <option value="modifiedDate_desc">æœ€çµ‚æ›´æ–°æ—¥æ™‚ (é™é †)</option>
            </select>
        </div>
    </div>

    <div id="status-message" class="py-3 px-4 rounded-lg text-sm text-gray-700 bg-white shadow mb-6">
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: æº–å‚™å®Œäº†
    </div>

    <div id="loading-container" class="text-center py-10 hidden">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4 mx-auto"></div>
        <p class="text-gray-600">ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’å–å¾—ä¸­ã§ã™... (å¤§é‡ã®APIã‚³ãƒ¼ãƒ«ãŒç™ºç”Ÿã—ã¾ã™)</p>
    </div>

    <div id="error-alert" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 hidden mb-6 rounded-lg" role="alert">
        <p class="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
        <p id="error-detail"></p>
    </div>

    <div id="deployment-list-container" class="shadow-xl rounded-lg overflow-hidden">
      <!-- ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>
  </div>

<script>
  const statusElement = document.getElementById('status-message');
  const listContainer = document.getElementById('deployment-list-container');
  const loadingContainer = document.getElementById('loading-container');
  const errorAlert = document.getElementById('error-alert');
  const errorDetail = document.getElementById('error-detail');
  const sortBySelect = document.getElementById('sort-by');
  
  const DATE_OPTIONS = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
  let currentData = [];

  /**
   * ISO 8601å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’æ•´å½¢ã™ã‚‹
   * @param {string} isoString - ISO 8601å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—
   * @returns {string} æ•´å½¢ã•ã‚ŒãŸæ—¥ä»˜æ–‡å­—åˆ—
   */
  function formatDate(isoString) {
      if (!isoString) return 'ä¸æ˜';
      try {
          // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒ­ã‚±ãƒ¼ãƒ«ã‚’æ­£ã—ãæ‰±ãˆã‚‹ã‚ˆã†ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚±ãƒ¼ãƒ«ã‚’ä½¿ç”¨
          return new Date(isoString).toLocaleDateString(undefined, DATE_OPTIONS);
      } catch (e) {
          return isoString; // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å…ƒã®æ–‡å­—åˆ—ã‚’è¿”ã™
      }
  }


  /**
   * ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰æœ€åˆã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
   */
  document.addEventListener('DOMContentLoaded', () => {
    loadData(false);
  });

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹
   */
  function clearCache() {
    statusElement.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™...';
    listContainer.innerHTML = '';
    loadingContainer.classList.remove('hidden');
    errorAlert.classList.add('hidden');

    google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleFailure)
        .clearCacheAndReload();
  }

  /**
   * ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
   * @param {boolean} forceReload - å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã‹ã©ã†ã‹
   */
  function loadData(forceReload) {
    statusElement.textContent = forceReload 
        ? 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶çš„ã«æ›´æ–°ã—ã¦ã„ã¾ã™...' 
        : 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™...';
    listContainer.innerHTML = '';
    loadingContainer.classList.remove('hidden');
    errorAlert.classList.add('hidden');
    
    google.script.run
        .withSuccessHandler(handleSuccess)
        .withFailureHandler(handleFailure)
        .loadDeploymentData();
  }

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‘¼ã³å‡ºã—ãŒæˆåŠŸã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ©
   * @param {string} responseJson - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰è¿”ã•ã‚ŒãŸJSONæ–‡å­—åˆ—
   */
  function handleSuccess(responseJson) {
    loadingContainer.classList.add('hidden');
    
    let data;
    try {
        data = JSON.parse(responseJson);
    } catch (e) {
        handleFailure('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ä¸æ­£ãªå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚');
        return;
    }

    if (data.error) {
        handleFailure(data.message);
        return;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´ã—ã€ã‚½ãƒ¼ãƒˆã‚’é©ç”¨
    currentData = data;

    const totalScripts = currentData.length;
    const errorCount = currentData.filter(item => item.status === 'ERROR').length;
    const successCount = totalScripts - errorCount;
    statusElement.innerHTML = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚ç·ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ•°: <b>${totalScripts}</b> (æˆåŠŸ: ${successCount}, ã‚¨ãƒ©ãƒ¼: ${errorCount})`;
    
    applySort(); // ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰å¾Œã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚½ãƒ¼ãƒˆã‚’é©ç”¨
  }

  /**
   * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒãƒ³ãƒ‰ãƒ©
   * @param {string} error - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   */
  function handleFailure(error) {
    loadingContainer.classList.add('hidden');
    statusElement.textContent = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ãƒ­ãƒ¼ãƒ‰å¤±æ•—';
    errorAlert.classList.remove('hidden');
    errorDetail.textContent = error.toString();
    listContainer.innerHTML = '<p class="text-center text-gray-500 py-10 bg-white rounded-lg">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
    console.error('GAS Server Error:', error);
  }
  
  /**
   * ã‚½ãƒ¼ãƒˆåŸºæº–ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦ã³æ›¿ãˆã€ãƒªã‚¹ãƒˆã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
   */
  function applySort() {
      if (currentData.length === 0) return;
      
      const sortValue = sortBySelect.value;
      const [key, order] = sortValue.split('_'); // ä¾‹: 'title_asc' -> ['title', 'asc']

      currentData.sort((a, b) => {
          let valA, valB;

          // ã‚¨ãƒ©ãƒ¼å„ªå…ˆã‚½ãƒ¼ãƒˆã‚’æœ€å„ªå…ˆ
          if (key === 'status') {
              // ERROR (a.status === 'ERROR') ã‚’æœ€å„ªå…ˆ (è² ã®å€¤ã‚’è¿”ã™)
              // æ—¢ã«ã‚¨ãƒ©ãƒ¼ã®ã‚½ãƒ¼ãƒˆã‚’æœ€åˆã«å®Ÿè¡Œæ¸ˆã¿ã¨è¦‹ãªã—ã€ä½•ã‚‚ã—ãªã„ï¼ˆå®‰å®šã‚½ãƒ¼ãƒˆï¼‰
              return (a.status === 'ERROR' ? -1 : 1);
          }
          
          if (key === 'title') {
              valA = a.title || '';
              valB = b.title || '';
          } else if (key === 'createdDate' || key === 'modifiedDate') {
              // æ—¥ä»˜ã¯æ¯”è¼ƒã®ãŸã‚ã«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
              // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã™ã‚‹å ´åˆï¼ˆä¸æ˜ãªå ´åˆï¼‰ã¯0ã¨ã—ã¦æ‰±ã†
              valA = a[key] ? new Date(a[key]).getTime() : 0;
              valB = b[key] ? new Date(b[key]).getTime() : 0;
          } else {
              return 0;
          }

          let comparison = 0;
          if (valA > valB) {
              comparison = 1;
          } else if (valA < valB) {
              comparison = -1;
          }

          // é™é †ã®å ´åˆã¯æ¯”è¼ƒçµæœã‚’åè»¢ã•ã›ã‚‹
          return order === 'asc' ? comparison : comparison * -1;
      });
      
      renderList(currentData);
  }


  /**
   * å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
   * @param {Array<Object>} data - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿
   */
  function renderList(data) {
    let html = '';
    
    data.forEach(item => {
      const isError = item.status === 'ERROR';
      const bgColor = isError ? 'bg-red-50' : 'bg-white';
      const titleColor = isError ? 'text-red-800' : 'text-gray-900';
      const statusIcon = isError ? 'âŒ' : 'âœ…';
      const deploymentsHtml = renderDeployments(item.webApps);

      html += `
        <div class="border-b last:border-b-0 p-4 ${bgColor} transition duration-100 ease-in-out hover:shadow-lg">
          <div class="flex items-start justify-between">
            <h2 class="text-lg font-semibold ${titleColor} mb-1 flex items-center space-x-2">
              <span>${statusIcon}</span>
              <span title="${item.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}">${item.title || 'ã‚¿ã‚¤ãƒˆãƒ«ä¸æ˜'}</span>
            </h2>
            <p class="text-sm font-medium ${isError ? 'text-red-500' : 'text-green-500'}">
              ${item.message}
            </p>
          </div>
          
          <div class="text-xs text-gray-500 mb-2 space-y-1">
              <p>Script ID: <code>${item.id || 'ä¸æ˜'}</code></p>
              <p>ä½œæˆæ—¥æ™‚: ${formatDate(item.createdDate)}</p>
              <p>æœ€çµ‚æ›´æ–°æ—¥æ™‚: ${formatDate(item.modifiedDate)}</p>
          </div>

          ${deploymentsHtml}
        </div>
      `;
    });

    listContainer.innerHTML = html;
  }

  /**
   * å„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæƒ…å ±ã‚’HTMLã¨ã—ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
   * @param {Array<Object>} webApps - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é…åˆ—
   * @returns {string} ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒªã‚¹ãƒˆã®HTML
   */
  function renderDeployments(webApps) {
    if (webApps.length === 0) {
      return '';
    }

    let deploymentsHtml = '<ul class="mt-3 space-y-1 text-sm">';
    webApps.forEach(app => {
      const accessColor = app.access.includes('ANYONE') ? 'text-orange-600' : 'text-blue-600';
      const versionDisplay = app.version === 'HEAD/LATEST' ? 'HEAD' : `Version: ${app.version}`;
      
      deploymentsHtml += `
        <li class="pl-3 border-l-2 border-gray-200">
          <span class="font-medium">${versionDisplay}</span>
          <span class="text-gray-400">|</span>
          <span class="${accessColor} font-medium">${app.access.replace('_ANONYMOUS', ' (åŒ¿å)')}</span>
          <span class="text-gray-400">|</span>
          <a href="${app.url}" target="_blank" class="text-blue-500 hover:underline">URLã‚’é–‹ã</a>
          <span class="text-gray-400">|</span>
          <span class="text-gray-500">å®Ÿè¡Œè€…: ${app.executeAs.replace('USER_DEPLOYING', 'ãƒ‡ãƒ—ãƒ­ã‚¤è€…').replace('USER_ACCESSING', 'ã‚¢ã‚¯ã‚»ã‚¹è€…')}</span>
        </li>
      `;
    });
    deploymentsHtml += '</ul>';
    return deploymentsHtml;
  }
</script>
</body>
</html>