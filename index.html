<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Apps Script プロジェクト管理</title>
    <link rel="icon" type="image/png" href="moukaeritai-pictgram/512x512-indianred-deeppink-18.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .hero {
            background: linear-gradient(45deg, #4A90E2, #50E3C2);
            color: white;
            padding: 4rem 2rem;
            text-align: center;
        }
        .hero h1 {
            font-weight: 700;
            font-size: 3.2rem;
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        #project-list .list-group-item {
            cursor: pointer;
        }
        #markdown-content img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>

    <header class="hero">
        <div class="container">
            <h1 class="mb-3">Google Apps Script Projects</h1>
            <p class="lead">以下の一覧からプロジェクトを選択してREADMEを表示します。</p>
            <a target="_blank" href="https://script.google.com/macros/s/AKfycbzzUFRxBjCOm7FFcOqC6KVd5n94r_5_PPwVn6WKd4lDkZRVQcAAfyk9hF7vnGFB2qtpOw/exec" class="btn btn-light btn-lg mt-3">GASプロジェクト管理アプリを開く</a>
        </div>
    </header>

    <main class="container my-5">
        <div class="row">
            <div class="col-md-4">
                <h2>プロジェクト一覧</h2>
                <input type="text" id="project-search" class="form-control mb-3" placeholder="検索...">
                <div id="project-list" class="list-group position-sticky" style="top: 20px;">
                    <!-- JSでリストが挿入される -->
                </div>
            </div>
            <div class="col-md-8">
                <h2 id="readme-title">README</h2>
                <div id="markdown-content" class="p-3 border rounded">
                    <p class="text-muted">左のリストからプロジェクトを選択してください。</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p class="mb-0">&copy; 2025 GAS もっと帰りたい. All Rights Reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const projectListEl = document.getElementById('project-list');
            const markdownContentEl = document.getElementById('markdown-content');
            const readmeTitleEl = document.getElementById('readme-title');
            const projectSearchEl = document.getElementById('project-search');

            // 1. clasp-list.jsonを読み込む
            fetch('clasp-list.json')
                .then(response => {
                    if (!response.ok) throw new Error('clasp-list.json not found');
                    return response.json();
                })
                .then(projects => {
                    // 2. プロジェクトリストを生成
                    projects.sort((a, b) => a.name.localeCompare(b.name)).forEach(project => {
                        const listItem = document.createElement('a');
                        listItem.className = 'list-group-item list-group-item-action';
                        listItem.textContent = project.name;
                        listItem.dataset.id = project.id;
                        projectListEl.appendChild(listItem);
                    });
                })
                .catch(error => {
                    console.error('Error fetching project list:', error);
                    projectListEl.innerHTML = '<p class="text-danger">プロジェクトリストを読み込めませんでした。</p>';
                });

            // 検索機能のインクリメンタルサーチ
            projectSearchEl.addEventListener('input', function(e) {
                const searchText = e.target.value.toLowerCase();
                const items = projectListEl.querySelectorAll('.list-group-item');

                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    if (text.includes(searchText)) {
                        item.classList.remove('d-none');
                    } else {
                        item.classList.add('d-none');
                    }
                });
            });

            // 3. リストクリック時のイベントハンドラ
            projectListEl.addEventListener('click', function(e) {
                if (e.target && e.target.matches('a.list-group-item')) {
                    e.preventDefault();
                    const projectId = e.target.dataset.id;
                    const projectName = e.target.textContent;

                    // アクティブな項目のスタイル設定
                    const activeItem = projectListEl.querySelector('.active');
                    if (activeItem) activeItem.classList.remove('active');
                    e.target.classList.add('active');

                    readmeTitleEl.textContent = `${projectName} - README`;
                    markdownContentEl.innerHTML = '<p class="text-muted">読み込み中...</p>';

                    // 4. 対応するREADME.mdを読み込む
                    fetch(`${projectId}/README.md`)
                        .then(response => {
                            if (!response.ok) {
                                if(response.status === 404) {
                                    throw new Error('README.md not found for this project.');
                                }
                                throw new Error('Could not fetch README.md');
                            }
                            return response.text();
                        })
                        .then(text => {
                            // 5. Markdownをレンダリング
                            markdownContentEl.innerHTML = marked.parse(text);
                        })
                        .catch(error => {
                            console.error('Error fetching or parsing markdown:', error);
                            if (error.message.includes('not found')) {
                                markdownContentEl.innerHTML = '<p class="text-muted">このプロジェクトにはREADME.mdファイルがありません。</p>';
                            } else {
                                markdownContentEl.innerHTML = '<p class="text-danger">READMEを読み込めませんでした。</p>';
                            }
                        });
                }
            });
        });
    </script>
</body>
</html>
