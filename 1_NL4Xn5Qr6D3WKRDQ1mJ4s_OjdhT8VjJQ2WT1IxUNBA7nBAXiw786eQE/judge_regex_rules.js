/**
 * @file judge_regex_rules.js
 * @fileoverview
 * ファイルタイトル判定システムのステップ2（中速ルールベース判定）を実装します。
 * このスクリプトは、Google Apps Script (GAS) での実行を前提としています。
 *
 * このステップは、API呼び出しを必要とせず、GASのみで実行されます。
 * 正規表現（RegExp）を使用して、ステップ1の高速チェックを通過した
 * タイトルの中から、不適切なパターンを検出します。
 */

// --- 判定パターン (正規表現) ---

/**
 * @const {Array<{type: string, regex: RegExp}>}
 * 不適切と判定するための正規表現パターンのリスト。
 * 判定はリストの順序通りに行われます。
 */
const REGEX_BAD_PATTERNS = [
  // 類型2: URL・URI
  // - https://... や http://... で始まるもの
  { type: 'URL・URI', regex: /^https?:\/\/.+/i },
  // - www.... で始まるもの (https:// が欠落している場合)
  { type: 'URL・URI', regex: /^www\..+\..+/i },

  // 類型5: タイムスタンプ・日付のみ
  // - 20251101.pdf や 20250720140844.pdf など、数字のみで構成されるファイル名
  { type: 'タイムスタンプ・日付のみ', regex: /^\d{8,14}\.\w+$/ },
  // - [temp_ocr] 2017年07月20日14時08分44秒
  { type: 'タイムスタンプ・日付のみ', regex: /^\[temp_ocr\].+/i },
  // - 2017年07月20日...
  { type: 'タイムスタンプ・日付のみ', regex: /^\d{4}年\d{1,2}月\d{1,2}日.+/ },

  // 類型6: OS・ブラウザによる自動命名サフィックス付き
  // - grok_report (1).pdf, report (2).docx など
  { type: 'OS自動命名サフィックス', regex: /.*\s*\(\d+\)\.\w+$/ },
  // - report (コピー).pdf
  { type: 'OS自動命名サフィックス', regex: /.*\s*\(コピー\)\.\w+$/ },

  // 類型3: 指示文・質問文・会話の断片
  // - 「この会話全体...」「その会話...」
  { type: '指示文・質問文・会話の断片', regex: /^(この|その)会話全体.+/ },
  // - 「...レポートを作成してください。」「...ドキュメントを作成してください。」
  { type: '指示文・質問文・会話の断片', regex: /.*(レポート|ドキュメント|説明|調査|整理|ドキュメント化|リストアップ)してください[。]?$/ },
  // - 「...教えてください。」「...調べてください。」
  { type: '指示文・質問文・会話の断片', regex: /.*(教えて|調べて)ください[。]?$/ },
  // - 「...なんですか？」「...ですか？」
  { type: '指示文・質問文・会話の断片', regex: /.*(なんですか？|ですか？|なぜですか|とは何ですか)[。]?$/ },
  // - 「...について説明してください。」
  { type: '指示文・質問文・会話の断片', regex: /.*について説明してください[。]?$/ },
  // - 「...を含めてください。」
  { type: '指示文・質問文・会話の断片', regex: /.*を含めてください[。]?$/ },
  // - 「なるほど...」「承知しました...」などの応答
  { type: '指示文・質問文・会話の断片', regex: /^(なるほど|承知しました|もちろんです|以下に).+/ },

  // 類型8: 文脈依存・暗号的なタイトル (一部の典型パターン)
  // - 1⃣用語の定義など
  { type: '文脈依存・暗号的', regex: /^\d⃣.+/ },
];

// --- 判定関数 ---

/**
 * ステップ2: 中速ルール（正規表現）に基づいてタイトルの不適切性を判定します。
 *
 * @param {string} title - 判定対象のファイルタイトル。
 * @returns {{isBad: boolean | null, type: string | null}} 判定結果オブジェクト。
 * isBad: true (不適切), false (適切)
 * ※ステップ2で判定できなかった場合は false (適切) を返します。
 */
function step2_checkRegexRules(title) {
  for (const pattern of REGEX_BAD_PATTERNS) {
    if (pattern.regex.test(title)) {
      return { isBad: true, type: pattern.type };
    }
  }

  // ステップ2では判定できなかった（不適切ではない）
  return { isBad: false, type: null };
}

// --- テスト実行 ---

/**
 * 動作テスト用の関数です。
 * GASエディタでこの関数を選択して実行してください。
 *
 * ※このテストは、ステップ1 (judge_fast_rules.js) が実行済みであることを前提としています。
 * ステップ1で検出されるべき "無題のドキュメント" や "README.md" は、
 * ここでは「適切」と判定されます（ステップ2の正規表現には一致しないため）。
 */
function runTest_Step2() {
  const testTitles = [
    // 適切なタイトルの例 (ステップ1, 2ともに通過すべき)
    "Git における pull・fetch・merge の動作理解と分岐ブランチの統合手順", // 適切
    "量子エンタングルメント（量子もつれ）に関する理解レポート", // 適切
    "sasakilab 2025-11-07 dmesg解析", // (ステップ2では判定できない)
    "20240122_ءا.pdf", // (ステップ2では判定できない)
    "カスタムプロンプト編集", // (ステップ2では判定できない)

    // 不適切なタイトルの例 (ステップ2で検出対象)
    "https://youtu.be/e1XT-6YpMKw", // 不適切 (類型2: URL)
    "grok_report (1).pdf", // 不適切 (類型6: OSサフィックス)
    "20251101.pdf", // 不適切 (類型5: 日付のみ)
    "[temp_ocr] 2017年07月20日14時08分44秒", // 不適切 (類型5: 日付のみ)
    "この会話全体の内容を整理して、詳細なレポートを作成してください。", // 不適切 (類型3: 指示文)
    "RANSACについて説明してください。", // 不適切 (類型3: 指示文)
    "IntelのCPUにおけるvminshiftってなんですか？", // 不適切 (類型3: 質問文)
    "1⃣用語の定義など", // 不適切 (類型8: 文脈依存)

    // ステップ1で検出されるタイトルの例 (参考: ステップ2では検出されない)
    "無題のドキュメント", // (ステップ1で検出されるため、ステップ2では「適切」判定)
    "README.md" // (ステップ1で検出されるため、ステップ2では「適切」判定)
  ];

  Logger.log("ステップ2 中速ルール(Regex)判定テストを開始します...");
  Logger.log("（※ステップ1を通過したという前提でテストしています）");

  testTitles.forEach(title => {
    const result = step2_checkRegexRules(title);
    let status = result.isBad ? '不適切' : '適切';
    Logger.log(`【${title}】 -> 判定: ${status} (${result.type || 'N/A'})`);
  });

  Logger.log("ステップ2 中速ルール(Regex)判定テストが完了しました。");
}