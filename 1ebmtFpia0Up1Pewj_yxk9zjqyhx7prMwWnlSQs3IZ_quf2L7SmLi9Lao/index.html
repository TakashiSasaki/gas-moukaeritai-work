<!DOCTYPE html>
<html lang="ja">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f4f7f9; font-family: 'Segoe UI', sans-serif; }
    .container { max-width: 900px; margin-top: 40px; }
    .stats-badge { font-size: 0.85rem; cursor: help; }
    .date-label { color: #6c757d; font-size: 0.75rem; }
    .card-title { color: #0d6efd; font-weight: 600; }
    
    /* 既定リスト用のスタイル */
    .card.default-list {
      border: 2px solid #0d6efd; /* 太めの青枠 */
      background-color: #f8fbff; /* 薄い青背景 */
    }
    
    .id-label {
      font-size: 0.65rem;
      color: #adb5bd;
      font-family: monospace;
      word-break: break-all;
    }

    /* Popover内のリストスタイル調整 */
    .popover-body ul { padding-left: 1.2rem; margin-bottom: 0; }
    .popover-body li { font-size: 0.85rem; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="mb-4">
      <h1 class="h3">Google Tasks アナリティクス</h1>
      <p class="text-secondary">複数リストの状況把握と管理</p>
    </header>

    <div id="loading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">タスク統計を計算中...</p>
    </div>
    
    <div id="task-list-container" class="row g-3">
      <!-- カード形式でリストを表示 -->
    </div>
  </div>

  <!-- Bootstrap Bundle JS (Popper.jsを含むためPopoverに必要) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      google.script.run
        .withSuccessHandler(renderTaskLists)
        .withFailureHandler(handleError)
        .getTaskLists();
    });

    function formatDate(isoString) {
      if (!isoString) return '---';
      const date = new Date(isoString);
      return date.toLocaleDateString('ja-JP', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    function renderTaskLists(lists) {
      document.getElementById('loading').style.display = 'none';
      const container = document.getElementById('task-list-container');
      
      container.innerHTML = lists.map(list => {
        // プレビュー用HTMLリストの生成
        const previewListHtml = list.previewTasks.length > 0
          ? `<ul class='mb-0'>${list.previewTasks.map(t => `<li>${escapeHtml(t)}</li>`).join('')}</ul>`
          : '<em>タスクなし</em>';

        // 既定リストかどうかの判定
        const defaultClass = list.isDefault ? 'default-list' : '';
        const defaultBadge = list.isDefault 
          ? '<span class="badge bg-primary ms-2" style="font-size: 0.7em;">Default</span>' 
          : '';

        return `
        <div class="col-md-6">
          <div class="card h-100 shadow-sm ${defaultClass}">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-1">
                <div>
                  <h5 class="card-title mb-0 d-inline-block">${escapeHtml(list.title)}</h5>
                  ${defaultBadge}
                </div>
                
                <!-- Popover属性 -->
                <span class="badge bg-secondary rounded-pill stats-badge"
                      data-bs-toggle="popover"
                      data-bs-trigger="hover focus"
                      data-bs-html="true"
                      data-bs-title="最新のタスク (Top 5)"
                      data-bs-content="${previewListHtml}">
                  ${list.taskCount} Tasks
                </span>
              </div>
              
              <!-- ID表示 -->
              <div class="mb-3">
                <span class="id-label">ID: ${list.id}</span>
              </div>

              <div class="mt-2 border-top pt-2">
                <div class="d-flex justify-content-between">
                  <span class="date-label">最古の更新:</span>
                  <span class="small">${formatDate(list.oldestDate)}</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="date-label">最新の更新:</span>
                  <span class="small">${formatDate(list.newestDate)}</span>
                </div>
              </div>
              <button class="btn btn-outline-primary btn-sm w-100 mt-3" 
                      onclick="selectList('${list.id}')">このリストを管理</button>
            </div>
          </div>
        </div>
      `}).join('');

      // 要素生成後にPopoverを初期化
      initPopovers();
    }

    /**
     * Bootstrap Popoverの初期化
     */
    function initPopovers() {
      const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
      popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl);
      });
    }

    function handleError(error) {
      document.getElementById('loading').style.display = 'none';
      alert('エラー: ' + error.message);
    }

    function selectList(id) {
      console.log('Targeting List:', id);
      // 次のフェーズ：タスク移動UIの起動
    }

    // XSS対策用エスケープ関数
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, function(match) {
        const escape = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        };
        return escape[match];
      });
    }
  </script>
</body>
</html>