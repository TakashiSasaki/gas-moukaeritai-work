<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Android Package List Viewer</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    // GASã‹ã‚‰æ¸¡ã•ã‚ŒãŸå…¨ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹
    let allDeviceData = [];

    google.charts.load('current', {'packages':['table']});
    google.charts.setOnLoadCallback(initializeUI);

    /**
     * UIã®åˆæœŸåŒ–ã‚’è¡Œã†
     */
    function initializeUI() {
      allDeviceData = <?!= JSON.stringify(deviceData || []) ?>;

      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã€ãƒ†ãƒ¼ãƒ–ãƒ«æç”»ã‚¨ãƒªã‚¢ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸€éƒ¨ã‚’éš ã™
      if (!allDeviceData || allDeviceData.length === 0) {
        document.getElementById('table_div').innerHTML = 
          '<div class="no-data-message">è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        document.getElementById('main_content_header').style.display = 'none';
        document.getElementById('meta_info_wrapper').style.display = 'none';
        document.querySelector('h2').style.display = 'none';
      } else {
        populateDeviceSelector();
        updateDisplay(0); // æœ€åˆã®ãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã‚’è¡¨ç¤º
      }
    }

    /**
     * ãƒ‡ãƒã‚¤ã‚¹é¸æŠç”¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹
     */
    function populateDeviceSelector() {
      const selector = document.getElementById('device_selector');
      allDeviceData.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = device.modelName;
        selector.appendChild(option);
      });
      // é¸æŠãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      selector.addEventListener('change', (event) => {
        updateDisplay(event.target.value);
      });
    }

    /**
     * é¸æŠã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {number} index - allDeviceDataé…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function updateDisplay(index) {
      const device = allDeviceData[index];
      
      // ãƒ¡ã‚¿æƒ…å ±ã‚’æ›´æ–°
      document.getElementById('android_id_display').textContent = device.androidId;
      document.getElementById('package_count_display').textContent = `ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ (${device.packageList.length}ä»¶)`;

      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
      drawTable(device.packageList);
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»ã™ã‚‹
     * @param {Array<string>} packageList - è¡¨ç¤ºã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é…åˆ—
     */
    function drawTable(packageList) {
      const data = new google.visualization.DataTable();
      data.addColumn('string', 'Package Name');
      const rows2 = packageList.map(pkg => [pkg]);
      const rows = packageList.map(pkg => {
        try {
          if (typeof pkg !== 'string' || !pkg) return ['(ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿)'];
          //const url = `https://play.google.com/store/apps/details?id=${encodeURIComponent(pkg)}`;
          const url = "https://www.example.com/"
          const link = `<a href="${url}" target="_blank" rel="noopener noreferrer">${pkg}</a>`;
          return [link];
        } catch (e) {
          // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã¯ã€å®‰å…¨ã®ãŸã‚ãƒªãƒ³ã‚¯ãªã—ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
          return [pkg]; 
        }
      });
      data.addRows(rows);

      const table = new google.visualization.Table(document.getElementById('table_div'));
      table.draw(data, { 
        showRowNumber: true, 
        width: '100%', 
        height: '100%',
        allowHtml: true, 
        sort: 'enable' 
      });
    }
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 20px auto; padding: 0 15px; }
    .container { border: 1px solid #ddd; border-radius: 8px; padding: 20px 25px; background-color: #f9f9f9; position: relative; }
    .user-info { position: absolute; top: 10px; right: 25px; font-size: 0.9em; color: #5f6368; }
    .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
    h1 { color: #1a73e8; margin: 0; }
    #device_selector { font-size: 1em; padding: 5px; border-radius: 4px; }
    .meta-info { background-color: #e8f0fe; border-left: 4px solid #1a73e8; padding: 10px 15px; margin: 20px 0; }
    #table_div { height: 450px; width: 100%; }
    .no-data-message { text-align: center; color: #777; padding-top: 80px; font-size: 1.1em; }
    /* --- ãƒ•ãƒƒã‚¿ãƒ¼æ¡ˆå†…ã®ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .footer-instructions {
        margin-top: 25px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        align-items: center;
        gap: 20px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆã®é–“éš” */
    }
    .footer-instructions img {
        border-radius: 12px;
        width: 60px;
        height: 60px;
    }
    .footer-instructions p {
        margin: 4px 0;
        font-size: 0.9em;
        color: #555;
    }
    .footer-instructions a {
        color: #1a73e8;
        text-decoration: none;
        font-weight: bold;
    }
    .footer-instructions a:hover {
        text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="user-info">
      ğŸ‘¤ <?= userEmail ?>
    </div>

    <div id="main_content">
      <div id="main_content_header" class="header-flex">
        <h1>Package Viewer</h1>
        <select id="device_selector" title="è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ"></select>
      </div>
    
      <div id="meta_info_wrapper" class="meta-info">
        <strong>Android ID:</strong> <span id="android_id_display"></span>
      </div>

      <h2 id="package_count_display">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ</h2>

      <div id="table_div"></div>
    </div>

    <div class="footer-instructions">
      <a href="https://llamalab.com/automate/" target="_blank" rel="noopener noreferrer">
        <img src="https://llamalab.com/img/automate/ic_launcher-128.png" alt="Automate icon">
      </a>
      <div>
        <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€<a href="https://llamalab.com/automate/" target="_blank" rel="noopener noreferrer"><strong>Automate</strong></a> ã¨é€£æºã—ã¾ã™ã€‚</p>
        <p>ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€<a href="https://llamalab.com/automate/community/flows/51123" target="_blank" rel="noopener noreferrer">ã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ•ãƒ­ãƒ¼</a>ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </div>
    
  </div>
</body>
</html>