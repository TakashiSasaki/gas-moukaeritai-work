<!DOCTYPE html>
<!-- index.html -->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- viewportã‚¿ã‚°ã¯Code.gsã§è¨­å®š -->
  <title>Android Package List Viewer</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    // å…¨ãƒ‡ãƒã‚¤ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let allDeviceData = [];

    // Google Chartsãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹
    google.charts.load('current', {'packages':['table']});
    google.charts.setOnLoadCallback(fetchInitialData);

    /**
     * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’éåŒæœŸã§å–å¾—ã™ã‚‹
     */
    function fetchInitialData() {
      google.script.run
        .withSuccessHandler(onDataReceived)
        .withFailureHandler(onDataError)
        .getDeviceDataForHtml();
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸæ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     * @param {Array<Object>} data - ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒã‚¤ã‚¹ãƒ‡ãƒ¼ã‚¿
     */
    function onDataReceived(data) {
      allDeviceData = data;
      
      // ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
      document.getElementById('initial-loader-overlay').style.display = 'none';
      document.querySelector('.container').style.display = 'block';

      // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€UIã®ä¸€éƒ¨ã‚’éš ã™
      if (!allDeviceData || allDeviceData.length === 0) {
        document.getElementById('table_div').innerHTML = 
          '<div class="no-data-message">è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        document.getElementById('main_content_header').style.display = 'none';
        document.getElementById('meta_info_wrapper').style.display = 'none';
        document.querySelector('h2').style.display = 'none';
      } else {
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯UIã‚’æ§‹ç¯‰
        populateDeviceSelector();
        updateDisplay(0); // æœ€åˆã®ãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã‚’è¡¨ç¤º
      }
    }

    /**
     * ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—æ™‚ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°
     * @param {Error} error - ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function onDataError(error) {
      document.getElementById('initial-loader-overlay').style.display = 'none';
      document.querySelector('.container').style.display = 'block';

      const mainContent = document.getElementById('main_content');
      mainContent.innerHTML = '<div class="error-message">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚<p style="font-size:0.8em; color:#777;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</p></div>';
      console.error('Failed to fetch data:', error);
    }

    /**
     * ãƒ‡ãƒã‚¤ã‚¹é¸æŠç”¨ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹
     */
    function populateDeviceSelector() {
      const selector = document.getElementById('device_selector');
      allDeviceData.forEach((device, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = device.modelName;
        selector.appendChild(option);
      });
      selector.addEventListener('change', (event) => {
        updateDisplay(event.target.value);
      });
    }

    /**
     * é¸æŠã•ã‚ŒãŸãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
     * @param {number} index - allDeviceDataé…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function updateDisplay(index) {
      const device = allDeviceData[index];
      document.getElementById('android_id_display').textContent = device.androidId;
      document.getElementById('package_count_display').textContent = "ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ (" + device.packageList.length + "ä»¶)";
      drawTable(device.packageList);
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã§ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»ã™ã‚‹
     * @param {Array<string>} packageList - è¡¨ç¤ºã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é…åˆ—
     */
    function drawTable(packageList) {
      const loader = document.getElementById('table-loader');
      loader.style.display = 'block';

      setTimeout(function() {
        const data = new google.visualization.DataTable();
        data.addColumn('string', 'Package Name');
        const rows = packageList.map(pkg => {
          try {
            if (typeof pkg !== 'string' || !pkg) return ['(ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿)'];
            const url = "intent:#Intent;package=" + pkg + ";end";
            const link = "<a href='" + url + "' target='_blank' rel='noopener noreferrer'>" + pkg + "</a>";
            return [link];
          } catch (e) {
            return [pkg]; 
          }
        });
        data.addRows(rows);

        const table = new google.visualization.Table(document.getElementById('table_div'));
        google.visualization.events.addListener(table, 'ready', function() {
          loader.style.display = 'none';
        });

        table.draw(data, { 
          showRowNumber: true, 
          width: '100%', 
          height: '100%',
          allowHtml: true, 
          sort: 'enable' 
        });
      }, 0);
    }
  </script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f0f2f5; }
    
    /* åˆæœŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #initial-loader-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      z-index: 9999;
    }
    .loader-text { margin-bottom: 20px; font-size: 1.2em; color: #555; }
    #initial-loader-overlay .loader {
      width: 50px; height: 50px; border: 6px solid #f3f3f3;
      border-top: 6px solid #1a73e8; border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .container { max-width: 800px; margin: 20px auto; padding: 0 15px; display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */ }
    .content-box { border: 1px solid #ddd; border-radius: 8px; padding: 20px 25px; background-color: #fff; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .user-info { position: absolute; top: 10px; right: 25px; font-size: 0.9em; color: #5f6368; }
    .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-wrap: wrap; }
    
    .title-group { display: flex; align-items: center; }
    .header-icon { width: 36px; height: 36px; margin-right: 15px; }
    h1 { color: #1a73e8; margin: 0; font-size: 1.8em; }

    #device_selector { font-size: 1em; padding: 8px 10px; border-radius: 4px; border: 1px solid #ccc; background-color: #fff; }
    .meta-info { background-color: #e8f0fe; border-left: 4px solid #1a73e8; padding: 10px 15px; margin: 20px 0; }
    
    #table_div { position: relative; height: 450px; width: 100%; }
    #table-loader {
      display: none; position: absolute; top: 40%; left: 50%;
      width: 40px; height: 40px; margin-left: -20px;
      border: 5px solid #f3f3f3; border-top: 5px solid #1a73e8;
      border-radius: 50%; animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .no-data-message, .error-message { text-align: center; color: #777; padding: 80px 20px; font-size: 1.1em; }
    .footer-instructions { margin-top: 25px; padding-top: 15px; border-top: 1px solid #ddd; }
    .footer-instructions p { margin: 4px 0; font-size: 0.9em; color: #555; }
    .footer-instructions a { color: #1a73e8; text-decoration: none; font-weight: bold; }
    .footer-instructions a:hover { text-decoration: underline; }
    .readme-links { margin-top: 1em; }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    @media (max-width: 600px) {
      .container {
        margin: 0;
        padding: 0;
      }
      .content-box {
        border-radius: 0;
        border-left: none;
        border-right: none;
        padding: 15px;
      }
      .user-info {
        position: static;
        text-align: right;
        margin-bottom: 10px;
        padding-right: 15px;
      }
      .header-flex {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      h1 {
        font-size: 1.6em;
      }
      #device_selector {
        width: 100%;
      }
      .footer-instructions {
        text-align: left;
      }
    }

  </style>
</head>
<body>
  <!-- åˆæœŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
  <div id="initial-loader-overlay">
    <div class="loader-text">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    <div class="loader"></div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="container">
    <div class="content-box">
      <div class="user-info">
        ğŸ‘¤ <?= userEmail ?>
      </div>

      <div id="main_content">
        <div id="main_content_header" class="header-flex">
          <div class="title-group">
            <!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰å¤‰æ›´ â–¼â–¼â–¼ -->
            <img src="<?= faviconUrl ?>" alt="App Icon" class="header-icon">
            <!-- â–²â–²â–² ã“ã“ã¾ã§å¤‰æ›´ â–²â–²â–² -->
            <h1>Package Viewer</h1>
          </div>
          <select id="device_selector" title="è¡¨ç¤ºã™ã‚‹ãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠ"></select>
        </div>
      
        <div id="meta_info_wrapper" class="meta-info">
          <strong>Android ID:</strong> <span id="android_id_display"></span>
        </div>

        <h2 id="package_count_display">ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ</h2>

        <div id="table_div">
          <div id="table-loader"></div>
        </div>
      </div>

      <div class="footer-instructions">
        <div>
          <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€<a href="https://llamalab.com/automate/" target="_blank" rel="noopener noreferrer"><strong>Automate</strong></a> ã¨é€£æºã—ã¾ã™ã€‚</p>
          <p>ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ã€<a href="https://llamalab.com/automate/community/flows/51123" target="_blank" rel="noopener noreferrer">ã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ•ãƒ­ãƒ¼</a>ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
          <p class="readme-links">
            <a href="<?= ScriptApp.getService().getUrl() ?>?page=readme-ja" target="_blank">ã‚¢ãƒ—ãƒªã®ä½¿ã„æ–¹ (æ—¥æœ¬èª)</a> | 
            <a href="<?= ScriptApp.getService().getUrl() ?>?page=readme-en" target="_blank">How to Use (English)</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
