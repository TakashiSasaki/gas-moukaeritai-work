<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    #controls {
      margin-bottom: 15px;
    }

    #fileIdInput {
      width: 300px;
      padding: 5px;
    }

    #browseButton {
      margin-left: 5px;
      padding: 5px 10px;
    }

    #extractButton {
      padding: 5px 10px;
    }

    #status {
      color: #888;
    }

    #result {
      width: 90%;
      height: 400px;
      border: 1px solid #ccc;
      padding: 10px;
      white-space: pre-wrap;
      overflow-y: auto;
      background-color: #f9f9f9;
    }

    #filePicker {
      display: none;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
      background-color: #fafafa;
    }

    #pickerNavigation {
      margin-bottom: 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }

    #pickerNavigation button {
      margin-right: 5px;
    }

    #pickerStatus {
      color: #888;
      font-style: italic;
    }

    #pickerList {
      list-style-type: none;
      padding-left: 0;
      margin-top: 5px;
    }

    #pickerList li {
      padding: 4px;
      cursor: pointer;
      border-radius: 3px;
    }

    #pickerList li:hover {
      background-color: #eee;
    }

    #pickerList li.file {
      font-weight: bold;
      color: #333;
    }

    #pickerList li.folder {
      color: #005a9c;
    }
  </style>
</head>

<body>
  <h2>Markdown æŠ½å‡ºãƒ„ãƒ¼ãƒ«</h2>

  <div id="controls">
    <label for="fileIdInput">ãƒ•ã‚¡ã‚¤ãƒ«ID:</label>
    <input type="text" id="fileIdInput" placeholder="Google Driveã®ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å…¥åŠ›">
    <button id="browseButton" onclick="togglePicker()">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ...</button>
    <button id="extractButton" onclick="extractMarkdown()">æŠ½å‡ºå®Ÿè¡Œ</button>
  </div>

  <div id="filePicker">
    <div id="pickerNavigation">
      <button id="navRootBtn" onclick="loadFolderContents('root')">ãƒ«ãƒ¼ãƒˆ</button>
      <button id="navUpBtn" onclick="loadParentFolder()">ä¸€ã¤ä¸Šã¸</button>
      <span id="currentFolderName" style="font-weight: bold;"></span>
    </div>
    <div id="pickerStatus"></div>
    <ul id="pickerList"></ul>
  </div>

  <div id="status">ã“ã“ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</div>
  <pre id="result">ã“ã“ã«æŠ½å‡ºçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</pre>

  <script>
    // --- UIè¦ç´  ---
      const fileIdInput = document.getElementById('fileIdInput');
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      const extractButton = document.getElementById('extractButton');
      const browseButton = document.getElementById('browseButton');
      const pickerEl = document.getElementById('filePicker');
      const pickerListEl = document.getElementById('pickerList');
      const pickerStatusEl = document.getElementById('pickerStatus');
      const currentFolderNameEl = document.getElementById('currentFolderName');
      const navUpBtn = document.getElementById('navUpBtn');
      // const navRefreshBtn = ... å‰Šé™¤

      // --- ãƒ”ãƒƒã‚«ãƒ¼ã®çŠ¶æ…‹ç®¡ç† ---
      let parentFolderId = null;
      // let currentLoadedFolderId = null; å‰Šé™¤

/**
       * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ”ãƒƒã‚«ãƒ¼ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
       * (1å›ç›®ã®ã‚¯ãƒªãƒƒã‚¯ã§å‹•ä½œã™ã‚‹ã‚ˆã†ã«ä¿®æ­£)
       */
      function togglePicker() {
        // ç¾åœ¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒ 'block' ã§ãªã„å ´åˆ (='none' ã¾ãŸã¯ åˆæœŸå€¤ '') ã¯ã€è¡¨ç¤ºã™ã‚‹
        if (pickerEl.style.display !== 'block') {
          pickerEl.style.display = 'block';
          // æœ€åˆã«ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ­ãƒ¼ãƒ‰ (å¼•æ•° 'root' ã¯ Code.gs å´ã§å‡¦ç†)
          loadFolderContents('root'); 
        } else {
          // ã™ã§ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹
          pickerEl.style.display = 'none';
        }
      }

      /**
       * ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ•ã‚©ãƒ«ãƒ€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
       */
      function loadFolderContents(folderId) {
        if (!folderId) return;
        
        pickerStatusEl.textContent = 'ãƒ•ã‚©ãƒ«ãƒ€å†…å®¹ã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...';
        pickerListEl.innerHTML = '';
        setPickerLoading(true);

        // getFolderContents ã‚’å‘¼ã³å‡ºã™ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—)
        google.script.run
          .withSuccessHandler(updatePickerUI)
          .withFailureHandler(onPickerFailure)
          .getFolderContents(folderId);
      }

      /**
       * ãƒ•ã‚©ãƒ«ãƒ€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ­ãƒ¼ãƒ‰ãŒæˆåŠŸã—ãŸã¨ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
       */
      function updatePickerUI(data) {
        setPickerLoading(false);
        pickerStatusEl.textContent = '';
        pickerListEl.innerHTML = ''; 
        
        if (data.error) {
          pickerStatusEl.textContent = data.error;
          return;
        }

        // è¦ªãƒ•ã‚©ãƒ«ãƒ€IDã®ã¿æ›´æ–°
        currentFolderNameEl.textContent = data.currentFolder.name;
        parentFolderId = data.parentFolder ? data.parentFolder.id : null;
        
        navUpBtn.disabled = (parentFolderId === null);

        // 1. ã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
        data.folders.forEach(folder => {
          const li = document.createElement('li');
          li.className = 'folder';
          li.textContent = `ğŸ“ ${folder.name}`;
          li.onclick = () => loadFolderContents(folder.id);
          pickerListEl.appendChild(li);
        });

        // 2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
        data.files.forEach(file => {
          const li = document.createElement('li');
          li.className = 'file';
          const ext = file.mimeType.split('.').pop();
          li.textContent = `ğŸ“„ ${file.name} (${ext})`;
          li.onclick = () => selectFile(file.id, file.name);
          pickerListEl.appendChild(li);
        });

        if (data.folders.length === 0 && data.files.length === 0) {
          pickerStatusEl.textContent = 'ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯ç©ºã§ã™ã€‚';
        }
      }
      
      /**
       * ãƒ”ãƒƒã‚«ãƒ¼ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¨­å®š
       */
      function setPickerLoading(isLoading) {
         document.getElementById('navRootBtn').disabled = isLoading;
         // navRefreshBtn.disabled = isLoading; å‰Šé™¤
         navUpBtn.disabled = isLoading || (parentFolderId === null);
      }

      /**
       * ã€Œä¸€ã¤ä¸Šã¸ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†
       */
      function loadParentFolder() {
        if (parentFolderId) {
          loadFolderContents(parentFolderId);
        }
      }

      // function refreshCurrentFolder() { ... } å‰Šé™¤

      /**
       * ãƒ•ã‚©ãƒ«ãƒ€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ãŸã¨ãã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
       */
      function onPickerFailure(error) {
        setPickerLoading(false);
        pickerStatusEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
      }

      /**
       * ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã¨ãã®å‡¦ç†
       */
      function selectFile(fileId, fileName) {
        fileIdInput.value = fileId;
        statusEl.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚`;
        pickerEl.style.display = 'none';
      }
      
      // --- æŠ½å‡ºå®Ÿè¡Œã®ãƒ­ã‚¸ãƒƒã‚¯ ---

      /**
       * æŠ½å‡ºãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
       */
      function extractMarkdown() {
        const fileId = fileIdInput.value;
        if (!fileId) {
          statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
          return;
        }

        statusEl.textContent = 'ã‚µãƒ¼ãƒãƒ¼ã§å‡¦ç†ä¸­...';
        resultEl.textContent = ''; 
        extractButton.disabled = true;
        browseButton.disabled = true;

        google.script.run
          .withSuccessHandler(onSuccess)
          .withFailureHandler(onFailure)
          .callExtractMarkdown(fileId);
      }

      /**
       * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‡¦ç†ãŒæˆåŠŸã—ãŸå ´åˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
       */
      function onSuccess(markdownText) {
        resultEl.textContent = markdownText;
        statusEl.textContent = 'å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
        extractButton.disabled = false;
        browseButton.disabled = false;
      }

      /**
       * ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã®å‡¦ç†ãŒå¤±æ•—ã—ãŸå ´åˆã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
       */
      function onFailure(error) {
        statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message;
        extractButton.disabled = false;
        browseButton.disabled = false;
      }
  </script>
</body>

</html>