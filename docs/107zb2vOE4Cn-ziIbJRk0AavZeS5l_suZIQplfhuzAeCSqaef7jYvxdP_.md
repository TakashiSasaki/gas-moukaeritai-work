# Project: Public ScriptCache

This Google Apps Script project implements a public-facing key-value cache service accessible via a web application. It allows users to store and retrieve string values using a combination of a `keyString` and an associated `email` (or its MD5 hash). The service utilizes `CacheService.getScriptCache()` for storage.

## Overview

The project provides HTTP endpoints (`doGet` and `doPost`) for interacting with a script-level cache. It's designed to be a generic caching mechanism where data is associated with both a key and a user's email, ensuring a degree of isolation and security by hashing these identifiers. It includes simple HTML interfaces for testing and demonstrating its functionality.

## Functionality

The core logic is distributed across several `.js` files:

-   **`doGet(e)`**:
    -   If no URL parameters are provided, it serves the `index.html` file, which provides basic information and client-side testing buttons.
    -   If `keyString` and either `email` or `emailMd5Base64WebSafe` are provided as URL parameters, it attempts to retrieve the corresponding value from the cache using `getFromCache`. The result is returned as a JSON object.
    -   Includes error handling to return JSON-formatted error messages.
-   **`doPost(e)`**:
    -   Expects a JSON payload in the request body containing `email`, `valueString`, and optionally `keyString` (or `emailMd5Base64WebSafe`).
    -   It uses `putToCache` to store the `valueString` in the cache. The `keyString` used for storage (either provided or generated) is returned in a JSON response.
    -   Explicitly rejects requests that include URL parameters with the POST method.
    -   Includes robust error handling.
-   **`getFromCache({keyString, email, emailMd5Base64WebSafe})`**:
    -   Retrieves a value from `CacheService.getScriptCache()`.
    -   A unique cache key is generated by XORing the MD5 hashes of the `keyString` and the provided `email` (or its Base64 web-safe MD5 hash). This mechanism aims to create a unique, non-guessable key for each `keyString`/`email` pair.
    -   Throws an error if `keyString` is missing or if no value is found for the computed cache key.
-   **`putToCache(o)`**:
    -   Stores a `valueString` in `CacheService.getScriptCache()`.
    -   If `o.keyString` is not provided, a UUID is generated for it.
    -   Similar to `getFromCache`, it computes a cache key by XORing the MD5 hashes of `keyString` and `email` (or its MD5 hash).
    -   Includes a check to ensure the length of the stored value matches the original `valueString` length, which can help detect issues with values being too long for the cache.
-   **`isNotEmptyString(x)`**: A utility function to validate if a given input `x` is a non-empty string.
-   **`misc.js`**: Contains a simple `myFunction` that calls `ScriptApp.getService().getUrl()`, likely a placeholder or for basic script URL retrieval.

```javascript
// Excerpt from getFromCache.js
function getFromCache({keyString, email, emailMd5Base64WebSafe}) {
  if (!isNonemptyString(keyString)) {
    throw new Error("keyString is mandatory.");
  }
  const keyMd5Byte = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, keyString);

  let emailMd5Byte = null;
  if (isNonemptyString(emailMd5Base64WebSafe) && !email) {
    emailMd5Byte = Utilities.base64DecodeWebSafe(emailMd5Base64WebSafe);
  } else if (isNonemptyString(email) && !emailMd5Base64WebSafe) {
    emailMd5Byte = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, email);
  } else {
    throw new Error("emailMd5Base64WebSafe or email is required.");
  }
  const xorByte = [];
  for (var i = 0; i < keyMd5Byte.length; ++i) {
    xorByte.push(emailMd5Byte[i] ^ keyMd5Byte[i]);
  }
  const xorBase64WebSafe = Utilities.base64EncodeWebSafe(xorByte);

  const cache = CacheService.getScriptCache();
  const value = cache.get(xorBase64WebSafe);
  if (!isNonemptyString(value)) {
    throw new Error("Failed to get valueString from the cache.");
  }
  return value;
}
```

## Web Interface

The project includes two HTML files for interaction and testing:

-   **`index.html`**: A basic page displaying the current, execution, and development URLs of the web app. It also features JavaScript buttons that demonstrate `doPost` (using `fetch` with a JSON payload) and `doGet` (using `fetch` without parameters) calls to the deployed web app.
-   **`test.html`**: Provides a more interactive testing interface with input fields for `key` and `value`. It uses `google.script.run` to call server-side functions (`putToCache`, `getFromCache`) directly from the client-side, facilitating testing of the cache operations.

## Permissions

The web application is configured with the following permissions:

-   **Execution**: `USER_DEPLOYING` (the script runs under the identity and permissions of the user who deployed the web app).
-   **Access**: `ANYONE_ANONYMOUS` (the web app is accessible by anyone, even users who are not logged into a Google account).
-   **Google Services**: Requires access to `CacheService` for storing and retrieving data, and `Utilities` for cryptographic operations (MD5 hashing, Base64 encoding/decoding) and UUID generation.

## Configuration

-   **Time Zone**: The project is configured for the `Asia/Tokyo` time zone.
-   **Dependencies**: No explicit advanced services are enabled in `appsscript.json`.

## Deployments

The project has multiple deployments, indicating different versions or testing stages:

-   **Deployment 1**:
    -   **ID**: `AKfycbwkbqxXue9rtkbXxS-b6XhDwlNQ8M57yzAvCkv-pKir`
    -   **Target**: `@HEAD`
    -   **Description**: _(none)_
    -   **Published URL**: [Link](https://script.google.com/macros/s/AKfycbwkbqxXue9rtkbXxS-b6XhDwlNQ8M57yzAvCkv-pKir/exec)
-   **Deployment 2 (Version 2)**:
    -   **ID**: `AKfycbwCk-bqUtw-nB5X5J6O1iWO4NpY3_V897tQex0ewF6UNFWeKfSlFj5acYlswUZ9ip84kQ`
    -   **Target**: `2`
    -   **Description**: `doPostとdoGetを実装した。` (Implemented doPost and doGet.)
    -   **Published URL**: [Link](https://script.google.com/macros/s/AKfycbwCk-bqUtw-nB5X5J6O1iWO4NpY3_V897tQex0ewF6UNFWeKfSlFj5acYlswUZ9ip84kQ/exec)
-   **Deployment 3 (Version 3)**:
    -   **ID**: `AKfycbwOR48gyJaPmrkdD5d2H007MYun7brScO8qZeuRNn6-8RpL25MTdUjKsjcVJnT6OaMtRA`
    -   **Target**: `3`
    -   **Description**: `doPost をテストしてる` (Testing doPost.)
    -   **Published URL**: [Link](https://script.google.com/macros/s/AKfycbwOR48gyJaPmrkdD5d2H007MYun7brScO8qZeuRNn6-8RpL25MTdUjKsjcVJnT6OaMtRA/exec)
-   **Deployment 4 (Version 1)**:
    -   **ID**: `AKfycbwN5eiwTjShyhZFaYI7RemVb5L_xB9r_xiXk2yfM39wT-oPnbfrwBTTV_-iDa7J4iCsPg`
    -   **Target**: `1`
    -   **Description**: _(none)_
    -   **Published URL**: [Link](https://script.google.com/macros/s/AKfycbwN5eiwTjShyhZFaYI7RemVb5L_xB9r_xiXk2yfM39wT-oPnbfrwBTTV_-iDa7J4iCsPg/exec)
