# Project: 1pI3uylENjL9mgMFifDvwraraNgxCnyjVN3Cx76xNH4qqWIxFqC5C_ctU

## Project Overview and Purpose

This Google Apps Script project is a web application designed to initiate an OAuth 2.0 authorization flow with Microsoft Online (specifically for `v2.0` endpoints). Its primary purpose is to obtain user consent for accessing Microsoft Graph data, such as `User.Read`. The application constructs a Microsoft authorization URL dynamically and presents it to the user via a simple HTML page. After successful authorization by the user, Microsoft redirects back to a callback function within the Google Apps Script, where further processing (e.g., exchanging the authorization code for an access token) would typically occur.

## Core Functionality

The project's core functionality is to facilitate the initial step of the Microsoft OAuth 2.0 authorization code flow.

### OAuth Authorization Flow Initiation (`Code.js`)

*   **`doGet(e)`**: This function serves as the entry point for the web application.
    *   It retrieves `idFromMicrosoft` and `valueFromMicrosoft` (likely a client secret, though not used in the authorization URL construction) from script properties.
    *   It dynamically constructs the `redirect_uri` for the OAuth flow, ensuring it points to the `usercallback` endpoint of the deployed Google Apps Script.
    *   It builds the Microsoft authorization URL (`https://login.microsoftonline.com/common/oauth2/v2.0/authorize`) with necessary parameters: `response_type=code`, `client_id`, `redirect_uri`, `state` (generated using `ScriptApp.newStateToken()`), and `scope=https://graph.microsoft.com/User.Read`.
    *   Finally, it renders `index.html`, passing the constructed `authUrl` to the template for display.

```javascript
function doGet(e) {
  const idFromMicrosoft = PropertiesService.getScriptProperties().getProperty("idFromMicrosoft");
  const valueFromMicrosoft = PropertiesService.getScriptProperties().getProperty("valueFromMicrosoft");
  
  const gasUrl = ScriptApp.getService().getUrl();
  if (gasUrl.indexOf("/exec") >= 0) {
    var redirectUriBase = gasUrl.slice(0, -4) + 'usercallback';
  } else {
    var redirectUriBase = gasUrl.slice(0, -3) + 'usercallback';
  }
  
  const authUrlBase = "https://login.microsoftonline.com/common/oauth2/v2.0/authorize";
  
  var param = {
    "response_type" : "code",
    "client_id" : idFromMicrosoft,
    "redirect_uri" : redirectUriBase,
    "state" : ScriptApp.newStateToken().withMethod("callbackFromMicrosoft").withArgument("hoge", "fuga").withTimeout(2000).createToken(),
    "scope" : "https://graph.microsoft.com/User.Read",
  };
  
  var paramArray = [];
  for(var name in param){ 
    paramArray.push(name + "=" + encodeURIComponent(param[name]));
  }

  const authUrl = authUrlBase + "?" + paramArray.join("&");
  Logger.log(authUrl);

  const template = HtmlService.createTemplateFromFile("index");  
  template.authUrl = authUrl;
  const output = template.evaluate();
  return output;
}
```

*   **`callbackFromMicrosoft(e)`**: This function is intended to be the callback endpoint for Microsoft's redirect after user authorization. Currently, it only logs the event object `e`. In a complete implementation, this function would extract the authorization `code` from `e.parameter` and exchange it for an access token using Microsoft's token endpoint.

```javascript
function callbackFromMicrosoft(e){
  Logger.log("callbackFromMicrosoft" + e);
}
```

## Web Interface

The project's web interface is defined in `index.html`.

### `index.html`

This simple HTML file serves as the user-facing component of the application:

*   It displays a hyperlink (`<a>` tag) whose `href` and text content are dynamically set to the `authUrl` generated by the `doGet` function.
*   The user clicks this link to be redirected to the Microsoft authorization page.

```html
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
  </head>
  <body>
    <a href="<?=authUrl?>"><?=authUrl?></a>
  </body>
</html>
```

## Permissions

The `appsscript.json` manifest file specifies the following permissions and access settings:

*   **Time Zone:** `Asia/Tokyo`
*   **Exception Logging:** `STACKDRIVER`
*   **Runtime Version:** `V8`
*   **Dependencies:** No external libraries are explicitly listed in `appsscript.json`.
*   **Web App Access:** `ANYONE` - The web application is accessible by anyone, including anonymous users.
*   **Web App Execution:** `USER_DEPLOYING` - The script runs under the identity of the user who deployed the web app. This is necessary for accessing script properties and making external requests.

## Configuration

*   **`idFromMicrosoft`**: A Microsoft client ID (Application ID) must be set as a script property (`PropertiesService.getScriptProperties()`) for the OAuth flow to function.
*   **`valueFromMicrosoft`**: This property is retrieved but not currently used in the provided `Code.js`. It would typically store a client secret for token exchange.

## Deployments

The project has the following deployments:

*   **Deployment ID:** `AKfycbxx6NIIILIRoRGnK1JJJGePL5DDFJaU8xih4ByZn4c`
    *   **Target Version:** `HEAD`
    *   **Description:** (empty)
    *   **Published URL:** `https://script.google.com/macros/s/AKfycbxx6NIIILIRoRGnK1JJJGePL5DDFJaU8xih4ByZn4c/exec`

*   **Deployment ID:** `AKfycbxhdFGx1Fp5ZE8pRomz3Zz0vMhmjuM6usyfRnBTvV4ts4ic0hQ`
    *   **Target Version:** `1`
    *   **Description:** `web app meta-version`
    *   **Published URL:** `https://script.google.com/macros/s/AKfycbxhdFGx1Fp5ZE8pRomz3Zz0vMhmjuM6usyfRnBTvV4ts4ic0hQ/exec`
